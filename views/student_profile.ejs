<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Profile – MD Technical School</title>
  <link rel="icon" href="<%= branding?.favicon %>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary-color: dodgerblue;
      --secondary-color: orange;
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
    }
    body{ background: var(--bg); font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }

    /* Hero */
    .profile-hero{
      background: linear-gradient(180deg, rgba(30,144,255,.10), rgba(255,165,0,.06));
      border-bottom: 1px solid var(--border);
      padding: 1.25rem 0;
      margin-bottom: 1rem;
    }
    .avatar{
      width: 56px; height: 56px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      font-weight: 700; color:#fff; background: var(--primary-color);
      box-shadow: 0 .25rem .75rem rgba(30,144,255,.25);
    }
    .headline h1{ margin:0; font-size: 1.35rem; font-weight: 800; }
    .subline{ color: var(--muted); }

    /* Status pill */
    .status{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .6rem; border-radius:999px; font-size:.875rem; font-weight:600;
      border:1px solid;
    }
    .status-approved{ color:#146c43; background:#d1e7dd; border-color:#badbcc; }
    .status-pending{ color:#8a6d3b; background:#fff3cd; border-color:#ffe69c; }
    .status-declined{ color:#842029; background:#f8d7da; border-color:#f5c2c7; }

    /* Cards & sections */
    .cardish{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1rem;
      box-shadow: 0 .5rem 1rem rgba(0,0,0,.05);
      margin-bottom: 1rem;
    }
    .section-title{
      display:flex; align-items:center; gap:10px; margin: 0 0 .75rem;
      font-weight: 700; color:#111827; font-size:1.05rem;
    }
    .section-title::before{
      content:""; width:6px; height:18px; border-radius:3px; background: var(--secondary-color);
    }

    /* Tables/lists */
    .table thead th{ background:#f8fafc; font-weight:600; }
    .table-bordered{ border-color: var(--border) !important; }
    .table-bordered > :not(caption) > * { border-color: var(--border) !important; }

    .muted{ color: var(--muted); }

    @media (min-width: 992px){
      .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    }
  </style>
</head>
<body>

  <div class="profile-hero">
    <div class="container d-flex align-items-center justify-content-between gap-3 flex-wrap">
      <div class="d-flex align-items-center gap-3">
        <div class="avatar">
          <%
            const FN = (student.profile?.firstName || '').trim();
            const LN = (student.profile?.lastName || '').trim();
            const initials = ((FN ? FN[0] : '') + (LN ? LN[0] : '') || (student.username?.slice(0,2) || 'ST')).toUpperCase();
          %>
          <%= initials %>
        </div>
        <div class="headline">
          <h1><%= FN %> <%= LN %></h1>
          <div class="subline">@<%= student.username %> • <%= student.email %></div>
        </div>
      </div>
      <div>
        <% const status = student.status || 'pending'; %>
        <span class="status <%= status==='approved'?'status-approved':(status==='declined'?'status-declined':'status-pending') %>">
          <%= status.charAt(0).toUpperCase() + status.slice(1) %>
        </span>
      </div>
    </div>
  </div>

  <div class="container pb-4">
      <% if (reset) { %>
      <div class="alert alert-success text-center">Password reset email sent.</div>
    <% } %>
    <!-- Key facts -->
    <div class="cardish">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="muted">Student ID</div>
          <div class="fw-semibold"><%= student.profile?.studentId || '-' %></div>
        </div>
        <div class="col-12 col-md-4">
          <div class="muted">Applied</div>
          <div class="fw-semibold"><%= student.appliedAt ? new Date(student.appliedAt).toLocaleString() : '-' %></div>
        </div>
        <div class="col-12 col-md-4">
          <div class="muted">Application Finished</div>
          <div class="fw-semibold"><%= student.finishedAt ? new Date(student.finishedAt).toLocaleString() : '—' %></div>
        </div>
      </div>
    </div>

    <!-- Personal / Program -->
    <div class="two-col">
      <section class="cardish">
        <div class="section-title">Personal</div>
        <div class="mb-2"><strong>Name:</strong> <%= student.name %> <%= student.profile?.suffix ? '('+student.profile.suffix+')' : '' %></div>
        <div class="mb-0">
          <strong>Address:</strong>
          <span>
            <%= student.profile?.address?.line1 || '' %>
            <%= student.profile?.address?.city ? ', ' + student.profile.address.city : '' %>
            <%= student.profile?.address?.state ? ', ' + student.profile.address.state : '' %>
            <%= student.profile?.address?.zip ? ' ' + student.profile.address.zip : '' %>
          </span>
        </div>
      </section>

      <section class="cardish">
        <div class="section-title">Program</div>
        <div class="mb-2"><strong>Course:</strong> <%= student.profile?.course || '-' %></div>
        <div class="mb-2"><strong>Affiliated Program:</strong> <%= student.profile?.affiliateProgram || '-' %></div>
        <div class="mb-0"><strong>Grievance Acknowledged:</strong> <%= student.profile?.grievanceAcknowledged ? 'Yes' : 'No' %></div>
      </section>
    </div>

    <!-- Uploaded Documents -->
    <section class="cardish">
      <div class="section-title">Uploaded Documents</div>
      <% const uploads = (student.profile && student.profile.uploads) || []; %>
      <% if (!uploads.length) { %>
        <div class="alert alert-secondary m-0">No uploaded documents.</div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead>
              <tr><th>File</th><th class="text-nowrap">Type</th><th class="text-nowrap">Size</th><th style="width:120px;">Action</th></tr>
            </thead>
            <tbody>
              <% uploads.forEach(u => { %>
                <tr>
                  <td><%= u.originalName %></td>
                  <td><span class="muted"><%= u.mimeType %></span></td>
                  <td><%= Math.round((u.size||0)/1024) %> KB</td>
                  <td><a class="btn btn-sm btn-outline-primary" href="<%= u.url %>" target="_blank" rel="noopener">Open</a></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>

    <!-- Agreements & Signatures -->
    <section class="cardish">
      <div class="section-title">Agreements & Signatures</div>
      <% const docs = (student.profile && student.profile.documents) || []; %>
      <% if (!docs.length) { %>
        <div class="alert alert-secondary m-0">No documents on file.</div>
      <% } else { %>
        <div class="row g-3">
          <% docs.forEach(d => { %>
            <div class="col-md-6">
              <div class="card h-100 border" style="border-color: var(--border);">
                <div class="card-body">
                  <h5 class="card-title text-capitalize mb-1"><%= d.type.replace(/-/g,' ') %></h5>
                  <div class="text-muted mb-2">Version: <%= d.version %> • Signed: <%= d.signedAt %></div>
                  <% if (d.signatureDataUrl) { %>
                    <img src="<%= d.signatureDataUrl %>" alt="Signature" style="max-width:100%;border:1px solid #ddd;background:#fff;border-radius:6px;">
                  <% } else { %>
                    <div class="text-muted">No signature on file.</div>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </section>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <a class="btn btn-link" href="javascript:history.back()">Back</a>
   <% if (role === 'admin' || role === 'teacher') { %>
        <form method="post" action="/<%= role %>/students/<%= student.id %>/reset-password" style="margin:0;" onsubmit="return confirm('Reset password for this user?');">
          <button class="btn btn-warning">Reset Password</button>
        </form>
      <% } %>    </div>
  </div>
</body>
</html>
