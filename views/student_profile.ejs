<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Profile – MD Technical School</title>
  <link rel="icon" href="<%= branding?.favicon %>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --primary-color: dodgerblue;
      --secondary-color: orange;
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
    }
    body{ background: var(--bg); font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }

    /* Hero */
    .profile-hero{
      background: linear-gradient(180deg, rgba(30,144,255,.10), rgba(255,165,0,.06));
      border-bottom: 1px solid var(--border);
      padding: 1.25rem 0;
      margin-bottom: 1rem;
    }
    .avatar{
      width: 56px; height: 56px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      font-weight: 700; color:#fff; background: var(--primary-color);
      box-shadow: 0 .25rem .75rem rgba(30,144,255,.25);
    }
    .headline h1{ margin:0; font-size: 1.35rem; font-weight: 800; }
    .subline{ color: var(--muted); }

    /* Status pill */
    .status{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .6rem; border-radius:999px; font-size:.875rem; font-weight:600;
      border:1px solid;
    }
    .status-approved{ color:#146c43; background:#d1e7dd; border-color:#badbcc; }
    .status-pending{ color:#8a6d3b; background:#fff3cd; border-color:#ffe69c; }
    .status-declined{ color:#842029; background:#f8d7da; border-color:#f5c2c7; }

    /* Cards & sections */
    .cardish{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1rem;
      box-shadow: 0 .5rem 1rem rgba(0,0,0,.05);
      margin-bottom: 1rem;
    }
    .section-title{
      display:flex; align-items:center; gap:10px; margin: 0 0 .75rem;
      font-weight: 700; color:#111827; font-size:1.05rem;
    }
    .section-title::before{
      content:""; width:6px; height:18px; border-radius:3px; background: var(--secondary-color);
    }

    /* Tables/lists */
    .table thead th{ background:#f8fafc; font-weight:600; }
    .table-bordered{ border-color: var(--border) !important; }
    .table-bordered > :not(caption) > * { border-color: var(--border) !important; }

    .muted{ color: var(--muted); }

    @media (min-width: 992px){
      .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    }

    /* PDF preview */
   .pdf-frame {
  width: 100%;
  height: 620px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #fff;
  margin: 0 auto 0.75rem; /* center horizontally, add bottom margin */
  display: block;
}
  </style>
</head>
<body>
<%
  // Helpers
  const FN = (student.profile?.firstName || '').trim();
  const LN = (student.profile?.lastName || '').trim();
  const initials = ((FN ? FN[0] : '') + (LN ? LN[0] : '') || (student.username?.slice(0,2) || 'ST')).toUpperCase();
  const status = student.status || 'pending';
  const maskSSN = (ssn) => {
    if (!ssn) return '-';
    const s = String(ssn).replace(/\D/g,'');
    const last4 = s.slice(-4);
    return '***-**-' + last4.padStart(4,'*');
  };
%>

  <div class="profile-hero">
    <div class="container d-flex align-items-center justify-content-between gap-3 flex-wrap">
      <div class="d-flex align-items-center gap-3">
        <div class="avatar"><%= initials %></div>
        <div class="headline">
          <h1><%= FN %> <%= LN %></h1>
          <div class="subline">@<%= student.username %> • <%= student.email %></div>
        </div>
      </div>
      <div>
        <span class="status <%= status==='approved'?'status-approved':(status==='declined'?'status-declined':'status-pending') %>">
          <%= status.charAt(0).toUpperCase() + status.slice(1) %>
        </span>
      </div>
    </div>
  </div>

  <div class="container pb-4">
    <% if (typeof reset !== 'undefined' && reset) { %>
      <div class="alert alert-success text-center">Password reset email sent.</div>
    <% } %>

    <!-- Key facts -->
    <div class="cardish">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="muted">Student ID</div>
          <div class="fw-semibold"><%= student.profile?.studentId || '-' %></div>
        </div>
        <div class="col-12 col-md-4">
          <div class="muted">Applied</div>
          <div class="fw-semibold"><%= student.appliedAt ? new Date(student.appliedAt).toLocaleString() : '-' %></div>
        </div>
        <div class="col-12 col-md-4">
          <div class="muted">Application Finished</div>
          <div class="fw-semibold"><%= student.finishedAt ? new Date(student.finishedAt).toLocaleString() : '—' %></div>
        </div>
      </div>
    </div>

    <!-- Personal / Program -->
    <div class="two-col">
      <section class="cardish">
        <div class="section-title">Personal</div>
        <div class="mb-2"><strong>Name:</strong> <%= student.name %> <%= student.profile?.suffix ? '('+student.profile.suffix+')' : '' %></div>
        <div class="mb-2">
          <strong>Address:</strong>
          <span>
            <%= student.profile?.address?.line1 || '' %>
            <%= student.profile?.address?.city ? ', ' + student.profile.address.city : '' %>
            <%= student.profile?.address?.state ? ', ' + student.profile.address.state : '' %>
            <%= student.profile?.address?.zip ? ' ' + student.profile.address.zip : '' %>
          </span>
        </div>
        <div class="mb-2"><strong>Phones:</strong> Home: <%= student.profile?.phones?.home || '-' %>, Cell: <%= student.profile?.phones?.cell || '-' %>, Work: <%= student.profile?.phones?.work || '-' %></div>
        <!-- MASKED SSN -->
        <div class="mb-2"><strong>SSN:</strong> <%= maskSSN(student.profile?.ssn) %></div>
        <div class="mb-0"><strong>Emergency Contact:</strong> <%= student.profile?.emergencyContact?.name || '-' %> (<%= student.profile?.emergencyContact?.relation || '-' %>) - <%= student.profile?.emergencyContact?.phone || '-' %></div>
      </section>

      <section class="cardish">
        <div class="section-title">Program</div>
        <div class="mb-2"><strong>Course:</strong> <%= student.profile?.course || '-' %></div>
        <div class="mb-2"><strong>Affiliated Program:</strong> <%= student.profile?.affiliateProgram || '-' %></div>
        <div class="mb-2"><strong>Admission Date:</strong> <%= student.profile?.program?.admissionDate || '-' %></div>
        <div class="mb-2"><strong>Start Date:</strong> <%= student.profile?.program?.startDate || '-' %></div>
        <div class="mb-2"><strong>End Date:</strong> <%= student.profile?.program?.endDate || '-' %></div>
        <div class="mb-2"><strong>Class Time:</strong> <%= student.profile?.program?.classTime || '-' %></div>
        <div class="mb-2"><strong>Days:</strong> <%= student.profile?.program?.classDays || '-' %></div>
        <div class="mb-2"><strong>Total Hours:</strong> <%= student.profile?.program?.totalHours || '-' %></div>
        <div class="mb-0"><strong>Grievance Acknowledged:</strong> <%= student.profile?.grievanceAcknowledged ? 'Yes' : 'No' %></div>
      </section>
    </div>

    <section class="cardish">
      <div class="section-title">Tuition</div>
      <div class="mb-2"><strong>Tuition:</strong> $<%= student.profile?.tuition?.tuition || '0' %></div>
      <div class="mb-2"><strong>Registration Fee:</strong> $<%= student.profile?.tuition?.registrationFee || '0' %></div>
      <div class="mb-2"><strong>Books/Supplies:</strong> $<%= student.profile?.tuition?.books || '0' %></div>
      <div class="mb-2"><strong>Equipment:</strong> $<%= student.profile?.tuition?.equipment || '0' %></div>
      <div class="mb-2"><strong>Misc. Fees:</strong> $<%= student.profile?.tuition?.miscFees || '0' %></div>
      <div class="mb-0"><strong>Total Cost:</strong> $<%= student.profile?.tuition?.totalCost || '0' %></div>
    </section>

    <!-- ADMIN EDIT: Step 2 + Tuition + Total Hours -->
    <% if (role === 'admin' && student.status === 'pending') { %>
    <section class="cardish">
      <div class="section-title">Step 2: Program Details</div>
      <form method="post" action="/admin/students/<%= student.id %>/step2" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Start Date</label>
          <input type="date" name="startDate" class="form-control" value="<%= student.profile?.program?.startDate || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">End Date</label>
          <input type="date" name="endDate" class="form-control" value="<%= student.profile?.program?.endDate || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">Class Time</label>
          <input name="classTime" class="form-control" value="<%= student.profile?.program?.classTime || '' %>">
        </div>
        <div class="col-md-6">
          <label class="form-label">Class Days</label>
          <input name="classDays" class="form-control" value="<%= student.profile?.program?.classDays || '' %>">
        </div>

        <!-- NEW: Total Hours -->
        <div class="col-md-6">
          <label class="form-label">Total Hours</label>
          <input type="number" step="1" min="0" name="totalHours" class="form-control" value="<%= student.profile?.program?.totalHours || '' %>">
        </div>

        <hr class="mt-2">

        <div class="col-12">
          <div class="section-title" style="margin-top:.25rem;">Tuition Breakdown</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Tuition</label>
          <input type="number" step="0.01" name="tuitionTuition" class="form-control" value="<%= student.profile?.tuition?.tuition || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">Registration Fee</label>
          <input type="number" step="0.01" name="tuitionRegistrationFee" class="form-control" value="<%= student.profile?.tuition?.registrationFee || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">Books/Supplies</label>
          <input type="number" step="0.01" name="tuitionBooks" class="form-control" value="<%= student.profile?.tuition?.books || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">Equipment</label>
          <input type="number" step="0.01" name="tuitionEquipment" class="form-control" value="<%= student.profile?.tuition?.equipment || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">Misc. Fees</label>
          <input type="number" step="0.01" name="tuitionMiscFees" class="form-control" value="<%= student.profile?.tuition?.miscFees || '' %>">
        </div>
        <div class="col-md-4">
          <label class="form-label">Total Cost</label>
          <input type="number" step="0.01" name="tuitionTotal" class="form-control" value="<%= student.profile?.tuition?.totalCost || '' %>">
        </div>

        <div class="col-12">
          <button class="btn btn-primary">Save &amp; Send Step 2</button>
        </div>
      </form>
    </section>
    <% } %>

    <% if (role === 'student') { %>
    <section class="cardish">
      <div class="section-title">Complete Registration</div>
      <form method="post" action="/student/profile/complete" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">SSN</label>
          <!-- mask input display; don't echo raw value -->
          <input name="ssn" type="password" class="form-control" placeholder="Enter SSN" autocomplete="off">
        </div>
        <div class="col-md-3">
          <label class="form-label">Emergency Contact</label>
          <input name="emergencyName" class="form-control" value="<%= student.profile?.emergencyContact?.name || '' %>">
        </div>
        <div class="col-md-3">
          <label class="form-label">Relationship</label>
          <input name="emergencyRelation" class="form-control" value="<%= student.profile?.emergencyContact?.relation || '' %>">
        </div>
        <div class="col-md-3">
          <label class="form-label">Emergency Phone</label>
          <input name="emergencyPhone" class="form-control" value="<%= student.profile?.emergencyContact?.phone || '' %>">
        </div>

        <div class="col-md-6">
          <label class="form-label">GED / HS Diploma / College Degree</label>
          <input type="file" name="gedDoc" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
        </div>
        <div class="col-md-6">
          <label class="form-label">Government Issued ID</label>
          <input type="file" name="govIdDoc" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
        </div>

        <div class="col-12">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="agree" name="agree" value="yes" <%= (student.profile?.documents||[]).find(d => d.type === 'registration-agreement')?.agreed ? 'checked' : '' %> required>
            <label class="form-check-label" for="agree">I have read and agree to the <a href="/docs/course-curriculm.pdf" target="_blank">Registration Agreement</a>.</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="grievanceAck" name="grievanceAck" value="yes" <%= student.profile?.grievanceAcknowledged ? 'checked' : '' %>>
            <label class="form-check-label" for="grievanceAck">I acknowledge I have received the grievance process information.</label>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-primary">Save</button>
        </div>
      </form>
    </section>
    <% } %>

    <!-- Uploaded Documents -->
    <section class="cardish">
      <div class="section-title">Uploaded Documents</div>
      <% const uploads = (student.profile && student.profile.uploads) || []; %>
      <% if (!uploads.length) { %>
        <div class="alert alert-secondary m-0">No uploaded documents.</div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead>
              <tr><th>File</th><th class="text-nowrap">Type</th><th class="text-nowrap">Size</th><th style="width:120px;">Action</th></tr>
            </thead>
            <tbody>
              <% uploads.forEach(u => { %>
                <tr>
                  <td><%= u.originalName %></td>
                  <td><span class="muted"><%= u.mimeType %></span></td>
                  <td><%= Math.round((u.size||0)/1024) %> KB</td>
                  <td><a class="btn btn-sm btn-outline-primary" href="<%= u.url %>" target="_blank" rel="noopener">Open</a></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>

    <!-- Agreements & Signatures -->
    <section class="cardish">
      <div class="section-title">Agreements &amp; Signatures</div>
      <% const docs = (student.profile && student.profile.documents) || []; %>
      <% if (!docs.length) { %>
        <div class="alert alert-secondary m-0">No documents on file.</div>
      <% } else { %>
        <div class="row g-3">
          <% docs.forEach(d => {
               const pdfSrc = (signatureDocsConfig && signatureDocsConfig[d.type]) || null;
          %>
            <div class="col-md-12">
              <div class="card h-100 border" style="border-color: var(--border);">
                <div class="card-body">
                  <h5 class="card-title text-capitalize mb-1"><%= d.type.replace(/-/g,' ') %></h5>
                  <div class="text-muted mb-2">Version: <%= d.version %> • Signed: <%= d.signedAt || '-' %></div>

                  <!-- PDF preview above signature -->
                  <% if (pdfSrc) { %>
                    <iframe class="pdf-frame" src="<%= pdfSrc %>#view=fitH" title="<%= d.type %> PDF"></iframe>
                  <% } %>

                  <% if (d.signatureDataUrl) { %>
                    <img src="<%= d.signatureDataUrl %>" alt="Signature" style="max-width:100%;border:1px solid #ddd;background:#fff;border-radius:6px;">
                  <% } else if (role === 'admin' && d.requiredRole === 'admin') { %>
                    <form method="post" action="/admin/students/<%= student.id %>/sign-doc" onsubmit="return capturePad('<%= d.type %>')">
                      <canvas class="sig" id="sig_<%= d.type %>" style="width:100%;height:160px;touch-action:none;border:1px solid #ced4da;border-radius:8px;"></canvas>
                      <div class="mt-1">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearPad('sig_<%= d.type %>')">Clear</button>
                      </div>
                      <input type="hidden" name="docType" value="<%= d.type %>">
                      <input type="hidden" name="signatureDataUrl" id="sigInput_<%= d.type %>">
                      <button class="btn btn-primary btn-sm mt-2">Sign</button>
                    </form>
                  <% } else if (role === 'student' && !d.requiredRole) { %>
                    <form method="post" action="/student/sign-doc" onsubmit="return capturePad('<%= d.type %>')">
                      <canvas class="sig" id="sig_<%= d.type %>" style="width:100%;height:160px;touch-action:none;border:1px solid #ced4da;border-radius:8px;"></canvas>
                      <div class="mt-1">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearPad('sig_<%= d.type %>')">Clear</button>
                      </div>
                      <input type="hidden" name="docType" value="<%= d.type %>">
                      <input type="hidden" name="signatureDataUrl" id="sigInput_<%= d.type %>">
                      <button class="btn btn-primary btn-sm mt-2">Sign</button>
                    </form>
                  <% } else { %>
                    <div class="text-muted">No signature on file.</div>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </section>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <a class="btn btn-link" href="javascript:history.back()">Back</a>
      <% if (role === 'admin' || role === 'teacher') { %>
        <form method="post" action="/<%= role %>/students/<%= student.id %>/reset-password" style="margin:0;" onsubmit="return confirm('Reset password for this user?');">
          <button class="btn btn-warning">Reset Password</button>
        </form>
      <% } %>
    </div>
  </div>

<% const adminDocs = docs.filter(d => !d.signatureDataUrl && d.requiredRole === 'admin'); %>
<% const studentDocs = docs.filter(d => !d.signatureDataUrl && !d.requiredRole); %>
<% if ((role === 'admin' && adminDocs.length) || (role === 'student' && studentDocs.length)) { %>
<script>
  const pads = {};
  function setupPad(id){
    const el=document.getElementById(id); const ctx=el.getContext('2d');
    const DPR=window.devicePixelRatio||1;
    function resize(){
      const r=el.getBoundingClientRect();
      el.width=r.width*DPR; el.height=r.height*DPR;
      ctx.setTransform(DPR,0,0,DPR,0,0);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    }
    resize(); window.addEventListener('resize',resize);
    let drawing=false,prev=null;
    function pos(e){const b=el.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:(t.clientX-b.left), y:(t.clientY-b.top)};}
    function start(e){drawing=true; prev=pos(e);}
    function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(p.x,p.y); ctx.stroke(); prev=p; }
    function end(){drawing=false;}
    el.addEventListener('mousedown',start); el.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
    el.addEventListener('touchstart',e=>{e.preventDefault();start(e);}); el.addEventListener('touchmove',e=>{e.preventDefault();move(e);}); window.addEventListener('touchend',end);
    pads[id]={el,ctx};
  }
  function clearPad(id){ const p=pads[id]; if(p) p.ctx.clearRect(0,0,p.el.width,p.el.height); }
  function capture(id){ const p=pads[id]; if(!p) return ''; return p.el.toDataURL('image/png'); }
  function capturePad(type){ const id='sig_'+type; const v=capture(id); document.getElementById('sigInput_'+type).value=v; if(!v){alert('Please sign before submitting.'); return false;} return true; }

  document.addEventListener('DOMContentLoaded', ()=>{
    <% if (role === 'admin') { adminDocs.forEach(d => { %>setupPad('sig_<%= d.type %>');<% }) } else { studentDocs.forEach(d => { %>setupPad('sig_<%= d.type %>');<% }) } %>
  });
</script>
<% } %>

</body>
</html>
