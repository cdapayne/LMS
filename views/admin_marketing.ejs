<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Marketing â€“ Admin | MD Technical School</title>
  <link rel="icon" href="<%= branding?.favicon %>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --primary-color: dodgerblue;
      --secondary-color: orange;
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
    }
    body{ background: var(--bg); font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .cardish{
      background: var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow: 0 .6rem 1.2rem rgba(0,0,0,.05);
      padding:1rem;
    }
    .btn-primary{ background: var(--primary-color) !important; border-color: var(--primary-color) !important; }
    .btn-primary:hover{ background:#1e6edb !important; border-color:#1e6edb !important; }
  </style>
</head>
<body>
  <%- include('header', { user: user }) %>
  <div class="container mt-4">
    <h2>Marketing Email</h2>
    <% if (sent) { %>
      <div class="alert alert-success">Email sent successfully.</div>
    <% } %>
    <% if (error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>
    <div class="cardish mt-3">
      <form id="marketingForm" method="post" action="/admin/marketing" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">Recipients</label>
            <div class="row g-2 mb-2">
              <div class="col-md-3">
                <input type="text" id="searchRecipients" class="form-control" placeholder="Search">
              </div>
              <div class="col-md-3">
                <select id="filterType" class="form-select">
                  <option value="">All Types</option>
                  <option value="student">Student</option>
                  <option value="pre">Pre-registered</option>
                  <option value="rsvp">RSVP</option>
                </select>
              </div>
              <div class="col-md-3">
                <select id="filterCourse" class="form-select">
                  <option value="">All Courses</option>
                  <% courses.forEach(c => { %>
                    <option value="<%= c %>"><%= c %></option>
                  <% }); %>
                </select>
              </div>
              <div class="col-md-3">
                <select id="filterProgram" class="form-select">
                  <option value="">All Programs</option>
                  <% programs.forEach(p => { %>
                    <option value="<%= p %>"><%= p %></option>
                  <% }); %>
                </select>
              </div>
            </div>
            <table class="table table-sm" id="recipientsTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAll"></th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Course</th>
                  <th>Program</th>
                  <th>Signed Up</th>
                </tr>
              </thead>
              <tbody id="recipientsBody">
                <% students.forEach(function(s){
                     const full = s.name || (s.profile?.firstName + ' ' + s.profile?.lastName);
                     const course = s.profile?.course || '';
                     const aff = s.profile?.affiliateProgram || '';
                     const signup = s.appliedAt ? new Date(s.appliedAt).toISOString().slice(0,10) : '';
                     const status = s.status === 'approved' ? 'Enrolled' : (s.status === 'declined' ? 'Denied' : 'Pending');
                %>
                  <tr data-type="student" data-course="<%= course %>" data-program="<%= aff %>" data-status="<%= status %>">
                    <td><input type="checkbox" name="recipients" value="student-<%= s.id %>"></td>
                    <td>Student</td>
                    <td><%= status %></td>
                    <td><%= full %></td>
                    <td><%= s.email %></td>
                    <td><%= course %></td>
                    <td><%= aff %></td>
                    <td><%= signup %></td>
                  </tr>
                <% }); %>
                <% preregs.forEach(function(p){ %>
                  <tr data-type="pre" data-course="<%= p.course || '' %>" data-program="" data-status="Pre-registered">
                    <td><input type="checkbox" name="recipients" value="pre-<%= p.id %>"></td>
                    <td>Pre-registered</td>
                    <td>Pre-registered</td>
                    <td><%= p.name %></td>
                    <td><%= p.email %></td>
                    <td><%= p.course || '' %></td>
                    <td></td>
                    <td></td>
                  </tr>
                <% }); %>
                <% rsvps.forEach(function(r){ %>
                  <tr data-type="rsvp" data-course="" data-program="" data-status="RSVP">
                    <td><input type="checkbox" name="recipients" value="rsvp-<%= r.id %>"></td>
                    <td>RSVP</td>
                    <td>RSVP</td>
                    <td><%= r.fullName %></td>
                    <td><%= r.email %></td>
                    <td></td>
                    <td></td>
                    <td></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <div class="mb-3">
          <label class="form-label">Email Type</label>
          <select name="type" class="form-select">
            <option value="recruitment">Recruitment</option>
            <option value="retention">Retention</option>
            <option value="approval">Approval</option>
            <option value="events">Events</option>
            <option value="information">Information</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Subject</label>
          <input type="text" name="subject" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Image</label>
          <input type="file" name="image" class="form-control" accept="image/*">
        </div>
        <div class="mb-3">
          <label class="form-label">Message</label>
          <textarea name="message" class="form-control" rows="6"></textarea>
        </div>
        <h5 class="mt-3">Preview</h5>
        <div id="preview" class="mt-1" style="display:none;"></div>
        <button type="submit" class="btn btn-primary">Send Email</button>
      </form>
    </div>
  </div>
  <script>
    const prefaces = {
      recruitment: 'Join the MD Technical School family!',
      retention: 'We value your continued learning with MDTS.',
      approval: 'Congratulations on your approval!',
      events: 'Upcoming opportunities await you at MDTS.',
      information: 'Here is an important update from MDTS.'
    };
    const templates = <%- JSON.stringify(templates) %>;
    const typeSelect = document.querySelector('select[name="type"]');
    const messageBox = document.querySelector('textarea[name="message"]');
    const subjectInput = document.querySelector('input[name="subject"]');
    const imageInput = document.querySelector('input[name="image"]');
    const previewDiv = document.getElementById('preview');
    const searchInput = document.getElementById('searchRecipients');
    const filterType = document.getElementById('filterType');
    const filterCourse = document.getElementById('filterCourse');
    const filterProgram = document.getElementById('filterProgram');
    const selectAll = document.getElementById('selectAll');
    let touched = false;
    messageBox.addEventListener('input', () => { touched = true; fetchPreview(); });
    imageInput.addEventListener('change', fetchPreview);

    function updatePreface() {
      if (touched && messageBox.value.trim()) return;
      const pre = prefaces[typeSelect.value] || '';
      messageBox.value = pre;
    }

    function updateSubject() {
      subjectInput.value = templates[typeSelect.value]?.subject || '';
    }

    async function fetchPreview() {
      const body = new FormData();
      body.append('type', typeSelect.value);
      body.append('message', messageBox.value);
      body.append('subject', subjectInput.value);
      if (imageInput.files[0]) body.append('image', imageInput.files[0]);
      const res = await fetch('/admin/marketing/preview', {
        method: 'POST',
        body
      });
      const data = await res.json();
      if (data.html) {
        previewDiv.style.display = 'block';
        previewDiv.innerHTML = data.html;
      }
    }

    function applyFilters() {
      selectAll.checked = false;
      const search = searchInput.value.toLowerCase();
      const typeVal = filterType.value;
      const courseVal = filterCourse.value.toLowerCase();
      const programVal = filterProgram.value.toLowerCase();
      document.querySelectorAll('#recipientsBody tr').forEach(tr => {
        const text = tr.innerText.toLowerCase();
        const type = tr.dataset.type;
        const course = (tr.dataset.course || '').toLowerCase();
        const program = (tr.dataset.program || '').toLowerCase();
        const matchesSearch = text.includes(search);
        const matchesType = !typeVal || type === typeVal;
        const matchesCourse = !courseVal || course === courseVal;
        const matchesProgram = !programVal || program === programVal;
        tr.style.display = matchesSearch && matchesType && matchesCourse && matchesProgram ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', applyFilters);
    filterType.addEventListener('change', applyFilters);
    filterCourse.addEventListener('change', applyFilters);
    filterProgram.addEventListener('change', applyFilters);

    selectAll.addEventListener('change', (e) => {
      document.querySelectorAll('#recipientsBody tr').forEach(tr => {
        if (tr.style.display !== 'none') {
          const cb = tr.querySelector('input[type="checkbox"]');
          cb.checked = e.target.checked;
        }
      });
    });

    document.querySelectorAll('#recipientsBody input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        if (!cb.checked) selectAll.checked = false;
      });
    });

    typeSelect.addEventListener('change', () => {
      touched = false;
      updatePreface();
      updateSubject();
      fetchPreview();
    });

    document.addEventListener('DOMContentLoaded', () => {
      updatePreface();
      updateSubject();
      fetchPreview();
      applyFilters();
    });
  </script>
</body>
</html>