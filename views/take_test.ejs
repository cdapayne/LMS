<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= test.title %> â€“ <%= klass.name %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <%- include('header', { user: typeof user !== 'undefined' ? user : { role: 'student' } }) %>
  <div class="container py-4">
    <h2><%= test.title %></h2>
    <p>Class: <%= klass.name %></p>
    <div class="mb-2">Current Grade: <span id="grade">0%</span></div>
    <div id="timer" class="mb-3">Time Left: <span id="time"></span></div>
    <form id="final-form" method="post" action="<%= action %>">
      <% (test.questions || []).forEach(function(q, i){ %>
        <div class="mb-4">
          <div class="mb-2">Question <%= i + 1 %> of <%= test.questions.length %></div>
          <% if (q.picture) { %>
            <img src="<%= q.picture %>" alt="Question Image" class="img-fluid mb-2" />
          <% } %>
          <p class="lead"><%= q.question %></p>
          <% q.options.forEach(function(opt, j){ %>
            <div class="form-check list-group-item">
              <input class="form-check-input" type="radio" name="q_<%= i %>" id="q<%= i %>_opt<%= j %>" value="<%= j %>">
              <label class="form-check-label" for="q<%= i %>_opt<%= j %>"><%= opt %></label>
            </div>
          <% }); %>
        </div>
      <% }); %>
      <button class="btn btn-primary">Submit</button>
    </form>
  </div>
  <script>
    const answers = <%- JSON.stringify((test.questions || []).map(q => Number(q.answer))) %>;
    const total = answers.length;
    let remaining = (<%= test.timeLimit || 90 %>) * total;
    function tick(){
      const m = Math.floor(remaining / 60);
      const s = remaining % 60;
      document.getElementById('time').textContent = `${m}:${s.toString().padStart(2,'0')}`;
      if(remaining <= 0){
        document.getElementById('final-form').submit();
      } else {
        remaining--;
        setTimeout(tick,1000);
      }
    }
    tick();
    document.getElementById('final-form').addEventListener('change', function(){
      let score = 0;
      answers.forEach((ans, i) => {
        const checked = document.querySelector(`input[name="q_${i}"]:checked`);
        if(checked && Number(checked.value) === ans) score++;
      });
      const pct = total ? ((score/total)*100).toFixed(2) : '0.00';
      document.getElementById('grade').textContent = pct + '%';
    });
  </script>
</body>
</html>
