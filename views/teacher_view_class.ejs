<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= klass.name %> ‚Äì Teacher View</title>
  <link rel="icon" href="<%= branding?.favicon %>" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --primary: #1e90ff;
      --primary-600: #1e6edb;
      --secondary: #ff9f1a;
      --bg: #f5f7fb;
      --surface: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --text: #0f172a;
      --shadow: 0 .5rem 1rem rgba(0,0,0,.06);
      --radius: 14px;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0b1220;
        --surface: #101828;
        --border: #253045;
        --muted: #9aa3b2;
        --text: #e6edf6;
        --shadow: 0 .5rem 1rem rgba(0,0,0,.35);
      }
      .table thead th{ background:#0f1a2f !important; }
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }

    /* Page header */
    .page-head{
      background:
        radial-gradient(1200px 120px at 10% -20%, rgba(30,144,255,.08), rgba(30,144,255,0) 60%),
        radial-gradient(1200px 120px at 90% -30%, rgba(255,159,26,.10), rgba(255,159,26,0) 60%);
      border-bottom: 1px solid var(--border);
      padding: 1.1rem 0;
      margin-bottom: 1rem;
    }
    .title-wrap h1{
      margin:0; font-weight:800; letter-spacing:.2px;
      font-size: clamp(1.15rem, 2.5vw, 1.5rem);
    }
    .meta{ color: var(--muted); }

    /* Section card */
    .cardish{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }
    .section-title{
      display:flex; align-items:center; gap:.6rem; margin:0 0 .85rem;
      font-weight:800; font-size:1.05rem;
    }
    .section-title .dot{
      width:10px; height:10px; border-radius:50%; background: var(--secondary);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--secondary) 20%, transparent);
    }

    /* Lists */
    .list-plain{ margin:0; padding-left:1rem; }
    .list-plain li{ margin:.25rem 0; }

    /* Tables */
    .table thead th{ background:#f8fafc; font-weight:600; }
    .table-bordered{ border-color: var(--border) !important; }
    .table-bordered > :not(caption) > * { border-color: var(--border) !important; }
    .table-wrap{ overflow-x:auto; }
    .badge-holiday{ background:#fff3cd; color:#7a5b00; border:1px solid #ffe69c; font-weight:600; }

    /* Buttons */
    .btn-primary{ background: var(--primary) !important; border-color: var(--primary) !important; }
    .btn-primary:hover{ background: var(--primary-600) !important; border-color: var(--primary-600) !important; }
    .btn-outline-primary{ color: var(--primary) !important; border-color: var(--primary) !important; }
    .btn-outline-primary:hover{ background: var(--primary) !important; color:#fff !important; }

    /* Utilities */
    .muted{ color:var(--muted); }
    .empty{
      border:1px dashed var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
      color: var(--muted);
    }
    :focus-visible{ outline: 3px solid color-mix(in srgb, var(--primary) 50%, transparent); outline-offset: 2px; border-radius: 8px; }

    /* Grid */
    @media (min-width: 992px){
      .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    }

    /* Mobile niceties */
    @media (max-width: 576px){
      .table th, .table td{ white-space: nowrap; }
      .att-row{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    }
  </style>
</head>
<body>
  <%- include('header', { user: { role: 'teacher' } }) %>

  <!-- Page Head -->
  <header class="page-head" role="banner" aria-label="Class header">
    <div class="container">
      <div class="title-wrap d-flex flex-wrap align-items-end justify-content-between gap-2">
        <div>
          <h1>
            <%= klass.name %>
            <% if (klass.shortName) { %><span class="muted"> (<%= klass.shortName %>)</span><% } %>
          </h1>
          <p class="meta mb-0">
            School Year: <strong><%= klass.schoolYear %></strong>
            &nbsp;‚Ä¢&nbsp; Cohort: <strong><%= klass.cohort %></strong>
            <% if (klass.weeks) { %> &nbsp;‚Ä¢&nbsp; Duration: <strong><%= klass.weeks %> weeks</strong><% } %>
          </p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" type="button" id="renameBtn">
            <i class="bi bi-pencil"></i> Rename
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container pb-4" role="main">
    <!-- About + Schedule -->
    <div class="two-col">
      <section class="cardish" aria-labelledby="overview-title">
        <div class="section-title"><span class="dot"></span><span id="overview-title">Overview</span></div>
        <% if (!klass.description) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üìù</div>
            <div class="fw-semibold">No description</div>
            <div class="small">Add a short summary so students know what to expect.</div>
          </div>
        <% } else { %>
          <p class="mb-0 text-muted"><%= klass.description %></p>
        <% } %>
        <% if (klass.startDate) { %>
          <div class="mt-3 small">
            <div><strong>First Day:</strong> <%= klass.startDate %></div>
            <div><strong>Last Day:</strong> <%= klass.endDate %></div>
            <div><strong>Starts in:</strong> <span id="startCountdown"></span></div>
          </div>
        <% } %>
      </section>

      <section class="cardish" aria-labelledby="schedule-title">
        <div class="section-title"><span class="dot"></span><span id="schedule-title">Schedule</span></div>
        <% function fmtTime(t){ if(!t) return ''; const parts=String(t).split(':'); let h=parseInt(parts[0],10), m=parts[1]||'00'; const ampm=h>=12?'PM':'AM'; h=h%12||12; return h+":"+m+" "+ampm; } %>
        <% if (!((klass.schedule||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üìÖ</div>
            <div class="fw-semibold">No scheduled meetings yet</div>
            <div class="small">Add day/time slots to populate the schedule.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.schedule||[]).forEach(s => { %>
              <li>
                <strong><%= s.day %></strong>: <%= fmtTime(s.start) %> ‚Äì <%= fmtTime(s.end) %>
                <% if (s.holiday) { %><span class="badge badge-holiday ms-2">Holiday</span><% } %>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </section>
    </div>

    <section class="cardish mt-3" id="checklist" aria-labelledby="checklist-title">
      <div class="section-title"><span class="dot"></span><span id="checklist-title">Class Checklist</span></div>
      <form method="post" action="/teacher/classes/<%= klass.id %>/checklist">
        <ul id="checklistItems" class="list-plain">
          <% (klass.checklist || []).forEach((item, idx) => { %>
            <li class="mb-2">
              <input type="checkbox" name="done" value="<%= idx %>" <%= item.done ? 'checked' : '' %>>
              <input type="text" name="item" value="<%= item.text %>" class="form-control d-inline-block w-auto">
            </li>
          <% }) %>
        </ul>
        <button type="button" class="btn btn-sm btn-secondary" id="addItem">Add Item</button>
        <button class="btn btn-sm btn-primary">Save Checklist</button>
      </form>
    </section>

       <!-- Lectures + Tests -->
    <div class="two-col">
      <section class="cardish" id="lectures" aria-labelledby="lectures-title">
        <div class="section-title"><span class="dot"></span><span id="lectures-title">Lectures</span></div>
        <% if (!((klass.lectures||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üé•</div>
            <div class="fw-semibold">No lectures linked</div>
            <div class="small">Attach lecture links or files for quick access.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.lectures || []).forEach(l => { %>
              <li class="mb-1">
                <% if (l.isPowerPoint) { %>
                  <a href="/student/powerpoint?url=<%= encodeURIComponent(l.url) %>&title=<%= encodeURIComponent(l.title) %>" target="_blank" rel="noopener"><%= l.title %> (PowerPoint)</a>
                <% } else { %>
                  <a href="<%= l.url %>" target="_blank" rel="noopener"><%= l.title %></a>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% } %>
                   <form method="POST" action="/teacher/classes/<%= klass.id %>/lectures" class="mt-3 d-flex gap-2 flex-wrap">
          <input type="text" name="title" class="form-control" placeholder="Title" style="max-width:200px">
          <input type="url" name="url" class="form-control" placeholder="URL">
          <button class="btn btn-sm btn-primary" type="submit">Add</button>
        </form>
      </section>
      <section class="cardish" id="simulations" aria-labelledby="sim-title">
        <div class="section-title"><span class="dot"></span><span id="sim-title">Simulations</span></div>
        <% if (!((klass.simulations||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üïπÔ∏è</div>
            <div class="fw-semibold">No simulations linked</div>
            <div class="small">Attach simulation links for practice.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.simulations || []).forEach(l => { %>
              <li class="mb-1"><a href="<%= l.url %>" target="_blank" rel="noopener"><%= l.title %></a></li>
            <% }) %>
          </ul>
        <% } %>
        <form method="POST" action="/teacher/classes/<%= klass.id %>/simulations" class="mt-3 d-flex gap-2 flex-wrap">
          <input type="text" name="title" class="form-control" placeholder="Title" style="max-width:200px">
          <input type="url" name="url" class="form-control" placeholder="URL">
          <button class="btn btn-sm btn-primary" type="submit">Add</button>
        </form>
      </section>

            <section class="cardish" id="assignments" aria-labelledby="assignments-title">
        <div class="section-title"><span class="dot"></span><span id="assignments-title">Assignments</span></div>
        <% if (!((klass.assignments||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üìò</div>
            <div class="fw-semibold">No assignments posted</div>
            <div class="small">Add assignment links for students.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.assignments || []).forEach(a => { %>
              <li class="mb-1"><a href="<%= a.url %>" target="_blank" rel="noopener"><%= a.title %></a> <span class="muted small"><%= a.date %></span></li>
            <% }) %>
          </ul>
        <% } %>
        <form method="POST" action="/teacher/classes/<%= klass.id %>/assignments" class="mt-3 d-flex gap-2 flex-wrap">
          <input type="text" name="title" class="form-control" placeholder="Title" style="max-width:200px">
          <input type="url" name="url" class="form-control" placeholder="URL">
            <input type="date" name="date" class="form-control" style="max-width:200px">
          <button class="btn btn-sm btn-primary" type="submit">Add</button>
        </form>
      </section>

      <section class="cardish" id="tests" aria-labelledby="tests-title">
   <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title mb-0"><span class="dot"></span><span id="tests-title">Tests</span></div>
          <a href="/teacher/classes/<%= klass.id %>/tests/new" class="btn btn-sm btn-outline-primary">Create Test</a>
        </div>        <% if (!((klass.tests||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üß™</div>
            <div class="fw-semibold">No tests created</div>
            <div class="small">Create tests to assess progress and readiness.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.tests || []).forEach(t => { %>
              <li class="mb-1"><%= t.title %> <a class="btn btn-sm btn-outline-primary ms-2" href="/teacher/classes/<%= klass.id %>/tests/<%= t.id %>/preview">Preview</a></li>
            <% }) %>
          </ul>
        <% } %>
         <div class="mt-3">
            <h6>Create AI Test</h6>
            <form method="POST" action="/teacher/classes/<%= klass.id %>/tests/generate">

          <input class="form-control mb-2" type="text" name="title" placeholder="Test title">
          <textarea class="form-control mb-2" name="prompt" placeholder="Topic or prompt"></textarea>
             <input class="form-control mb-2" type="number" name="timeLimit" value="90" min="1" placeholder="Seconds per question">
          <button class="btn btn-sm btn-primary" type="submit">Generate via AI</button>
        </form>
          </div>
          <div class="mt-3">
            <h6>Upload Excel Test</h6>
            <form method="POST" action="/teacher/classes/<%= klass.id %>/tests/upload" enctype="multipart/form-data">

          <input class="form-control mb-2" type="text" name="title" placeholder="Test title">
          <input class="form-control mb-2" type="file" name="csv" accept=".csv,.xlsx">
               <input class="form-control mb-2" type="number" name="timeLimit" value="90" min="1" placeholder="Seconds per question">
          <button class="btn btn-sm btn-secondary" type="submit">Upload Excel</button>
        </form>
          </div>
          <div class="mt-3">
            <h6>Upload Test Media</h6>
            <form method="POST" action="/teacher/classes/<%= klass.id %>/tests/media" enctype="multipart/form-data">

          <input class="form-control mb-2" type="file" name="media" accept="image/*,audio/*,video/*">
          <button class="btn btn-sm btn-secondary" type="submit">Upload Test Media</button>
        </form>
          </div>
      </section>
    </div>

    <!-- Attendance -->
    <section class="cardish" aria-labelledby="attendance-title">
      <div class="section-title"><span class="dot"></span><span id="attendance-title">Attendance</span></div>
      <form method="POST" action="/teacher/classes/<%= klass.id %>/attendance" class="mb-3">
        <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
          <label class="form-label m-0" for="att-date">Date</label>
          <input id="att-date" type="date" name="date" value="<%= today %>" class="form-control" style="max-width:220px">
          <button type="submit" class="btn btn-primary ms-auto">Save Attendance</button>
        </div>

        <% if (!(students||[]).length) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üßë‚Äçüè´</div>
            <div class="fw-semibold">No students in roster</div>
            <div class="small">Add students to take attendance.</div>
          </div>
        <% } else { %>
          <div class="table-wrap d-none d-sm-block">
            <table class="table table-bordered align-middle mb-0">
              <thead>
                <tr>
                  <th style="min-width:220px">Student</th>
                  <th class="text-center" style="width:160px">Present</th>
                </tr>
              </thead>
              <tbody>
                <% (students||[]).forEach(s => { %>
                  <tr>
                    <td><%= s.name %></td>
                    <td class="text-center">
                      <div class="form-check form-switch d-inline-flex align-items-center justify-content-center">
                        <input class="form-check-input" type="checkbox" name="present_<%= s.id %>"
                          <%= (attendanceToday.present || []).includes(s.id) ? 'checked' : '' %>>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <!-- Mobile stacked list for attendance -->
          <div class="d-sm-none">
            <% (students||[]).forEach(s => { %>
              <div class="att-row border rounded-3 p-2 mb-2">
                <div class="fw-semibold"><%= s.name %></div>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" name="present_<%= s.id %>"
                    <%= (attendanceToday.present || []).includes(s.id) ? 'checked' : '' %>>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </form>

      <h6 class="mt-3">Attendance Records</h6>
      <% if (!((klass.attendance||[]).length)) { %>
        <div class="empty">No attendance records yet.</div>
      <% } else { %>
        <div class="table-wrap">
          <table class="table table-bordered mb-0">
            <thead><tr><th style="min-width:140px">Date</th><th>Present Students</th></tr></thead>
            <tbody>
              <% (klass.attendance || []).sort((a,b)=>a.date.localeCompare(b.date)).forEach(a => { %>
                <tr>
                  <td><%= a.date %></td>
                  <td>
                    <%= a.present
                          .map(id => { const stu = (students||[]).find(s => s.id===id); return stu ? stu.name : ''; })
                          .filter(Boolean)
                          .join(', ') %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
      </section>

       <!-- Discussion Board -->
      <section class="cardish" id="discussion" aria-labelledby="discussion-title">
        <div class="section-title"><span class="dot"></span><span id="discussion-title">Discussion Board</span></div>
        <% if (!(discussions||[]).length) { %>
          <div class="empty">No messages yet.</div>
        <% } else { %>
          <ul class="list-plain">
            <% discussions.forEach(d => { %>
              <li class="mb-1"><strong><%= d.name %>:</strong> <%= d.message %> <span class="muted small"><%= new Date(d.createdAt).toLocaleString() %></span></li>
            <% }) %>
          </ul>
        <% } %>
        <form method="POST" action="/teacher/classes/<%= klass.id %>/discussion" class="mt-3 d-flex gap-2">
          <input type="text" name="message" class="form-control" placeholder="Enter message">
          <button type="submit" class="btn btn-primary btn-sm">Post</button>
        </form>
      </section>
   <!-- Grades -->
      <section class="cardish" aria-labelledby="grades-title">
      <div class="d-flex align-items-center justify-content-between">
        <div class="section-title mb-0"><span class="dot"></span><span id="grades-title">Students & Grades</span></div>
        <div class="d-flex gap-2">
          <button type="button" id="exportGradesCsv" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export CSV</button>
          <a href="/teacher/classes/<%= klass.id %>/attendance" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-clipboard2-check"></i> Attendance Report
          </a>
        </div>
      </div>

      <% if (!(students||[]).length) { %>
        <div class="empty mt-3">No students to display.</div>
      <% } else { %>
          <form method="POST" action="/teacher/classes/<%= klass.id %>/grades" class="mt-3">
          <div class="table-wrap">
            <table id="gradesTable" class="table table-bordered">
              <thead>
                <tr>
                  <th style="min-width:220px">Student</th>
                  <% (klass.tests||[]).forEach(t=>{ %>
                    <th><%= t.title %></th>
                  <% }) %>
                  <% (klass.assignments||[]).forEach(a=>{ %>
                    <th><%= a.title %></th>
                  <% }) %>
                  <% (klass.simulations||[]).forEach(l=>{ %>
                    <th><%= l.title %> Lab</th>
                  <% }) %>
                </tr>
              </thead>
              <tbody>
                <% (students||[]).forEach(s => { %>
                  <tr>
                    <td><a href="/teacher/students/<%= s.id %>"><%= s.name %></a></td>
                    <% (klass.tests||[]).forEach(t => { %>
                      <% const g = (klass.grades||[]).find(gr => gr.testId===t.id && gr.studentId===s.id); %>
                      <td><input type="number" name="grade_<%= s.id %>_<%= t.id %>" class="form-control form-control-sm" min="0" max="100" value="<%= g ? g.score : '' %>"></td>
                    <% }) %>
                    <% (klass.assignments||[]).forEach(a => { %>
                      <% const g = (klass.grades||[]).find(gr => gr.assignmentId===a.id && gr.studentId===s.id); %>
                      <td><input type="number" name="asg_<%= s.id %>_<%= a.id %>" class="form-control form-control-sm" min="0" max="100" value="<%= g ? g.score : '' %>"></td>
                    <% }) %>
                    <% (klass.simulations||[]).forEach(l => { %>
                      <% const g = (klass.grades||[]).find(gr => gr.labId===l.id && gr.studentId===s.id); %>
                      <td class="text-center">
                        <input class="form-check-input" type="checkbox" name="lab_<%= s.id %>_<%= l.id %>" <%= g && g.passed ? 'checked' : '' %>>
                      </td>
                    <% }) %>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-primary mt-2">Save Grades</button>
        </form>
      <% } %>
    </section>
  </main>
    <% if (klass.startDate) { %>
  <script>
    (function(){
      const el=document.getElementById('startCountdown');
      if(!el) return;
      const start=new Date('<%= klass.startDate %>');
      function update(){
        const diff=start - new Date();
        const days=Math.ceil(diff/86400000);
        el.textContent = days>0 ? days + ' days' : 'Started';
      }
      update();
    })();
  </script>
  <% } %>
  <script>
    (function(){
      const add=document.getElementById('addItem');
      const list=document.getElementById('checklistItems');
      add?.addEventListener('click', () => {
        const idx=list.children.length;
        const li=document.createElement('li');
        li.className='mb-2';
        li.innerHTML=`<input type="checkbox" name="done" value="${idx}"> <input type="text" name="item" class="form-control d-inline-block w-auto">`;
        list.appendChild(li);
      });
    })();
  </script>

  <script>
    (function(){
      const btn=document.getElementById('exportGradesCsv');
      const table=document.getElementById('gradesTable');
      btn?.addEventListener('click',()=>{
        if(!table) return;
        const rows=Array.from(table.querySelectorAll('tr')).map(tr=>Array.from(tr.cells).map(td=>{
          const input=td.querySelector('input');
          const text=input?input.value:td.innerText;
          const t=text.replace(/\r?\n+/g,' ').trim();
          return /[",]/.test(t)?'"'+t.replace(/"/g,'""')+'"':t;
        }).join(','));
        const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download=`grades_<%= (klass.shortName || klass.name).toString().replace(/\s+/g,"_").toLowerCase() %>.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });
    })();
  </script>

  <script>
    document.getElementById('renameBtn')?.addEventListener('click', () => {
      const newName = prompt('Enter new class name:', <%- JSON.stringify(klass.name) %>);
      if (newName && newName.trim()) {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/teacher/classes/<%= klass.id %>/rename';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'name';
        input.value = newName.trim();
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
      }
    });
  </script>
</body>
</html>
