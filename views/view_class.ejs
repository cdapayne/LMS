<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= klass.name %><% if (klass.shortName) { %> (<%= klass.shortName %>)<% } %> ‚Äì MD Technical School</title>
  <link rel="icon" href="<%= branding?.favicon %>">

  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #1e90ff;
      --primary-600: #1e6edb;
      --secondary: #ff9f1a;
      --bg: #f5f7fb;
      --surface: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --text: #0f172a;
      --shadow: 0 .5rem 1rem rgba(0,0,0,.06);
      --radius: 14px;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0b1220;
        --surface: #101828;
        --border: #253045;
        --muted: #9aa3b2;
        --text: #e6edf6;
        --shadow: 0 .5rem 1rem rgba(0,0,0,.35);
      }
      .table thead th{ background: #0f1a2f !important; }
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }

    /* Page head / hero */
    .page-head{
      background:
        radial-gradient(1200px 120px at 10% -20%, rgba(30,144,255,.08), rgba(30,144,255,0) 60%),
        radial-gradient(1200px 120px at 90% -30%, rgba(255,159,26,.10), rgba(255,159,26,0) 60%);
      border-bottom: 1px solid var(--border);
      padding: 1.1rem 0;
      margin-bottom: 1rem;
    }
    .page-head h1{
      font-weight: 800; letter-spacing:.2px; font-size: clamp(1.1rem, 2.5vw, 1.5rem);
      margin: 0 0 .15rem 0;
    }
    .page-meta{ color: var(--muted); font-size: .95rem; }
    .action-bar .btn{ border-radius: 12px; }

    /* Card */
    .cardish{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }
    .section-title{
      display:flex; align-items:center; gap:.6rem; font-weight:800; margin-bottom:.85rem;
      font-size: 1.05rem;
    }
    .section-title .dot{
      width:10px; height:10px; border-radius:50%; background: var(--secondary);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--secondary) 20%, transparent);
    }

    /* Lists / tables */
    .list-plain{ margin:0; padding-left:1rem; }
    .table thead th{ background:#f8fafc; font-weight:600; }
    .table-bordered{ border-color: var(--border) !important; }
    .table-bordered > :not(caption) > * { border-color: var(--border) !important; }

    .badge-holiday{
      background:#fff3cd; color:#7a5b00; border:1px solid #ffe69c;
      font-weight:600;
    }

    /* Buttons */
    .btn-primary{ background: var(--primary) !important; border-color: var(--primary) !important; }
    .btn-primary:hover{ background: var(--primary-600) !important; border-color: var(--primary-600) !important; }
    .btn-outline-primary{ color: var(--primary) !important; border-color: var(--primary) !important; }
    .btn-outline-primary:hover{ background: var(--primary) !important; color:#fff !important; }

    /* Utilities */
    .empty{
      border:1px dashed var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
      color: var(--muted);
    }
    :focus-visible{ outline: 3px solid color-mix(in srgb, var(--primary) 50%, transparent); outline-offset: 2px; border-radius: 8px; }

    /* Responsive grid */
    @media (min-width: 992px){
      .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    }
  </style>
</head>
<body>
  <%- include('header', { user: (typeof studentView !== 'undefined' && studentView) ? { role: 'student' } : { role: 'admin' } }) %>

  <header class="page-head" role="banner" aria-label="Class header">
    <div class="container d-flex flex-wrap justify-content-between align-items-end gap-2">
      <div>
        <h1>
          <%= klass.name %>
          <span class="text-muted"><% if (klass.shortName) { %>(<%= klass.shortName %>)<% } %></span>
        </h1>
        <p class="page-meta mb-0">
          School Year: <strong><%= klass.schoolYear %></strong>
          &nbsp;‚Ä¢&nbsp; Cohort: <strong><%= klass.cohort %></strong>
          <% if (klass.weeks) { %>&nbsp;‚Ä¢&nbsp; Duration: <strong><%= klass.weeks %> weeks</strong><% } %>
        </p>
      </div>

      <% if (typeof studentView === 'undefined' || !studentView) { %>
      <div class="action-bar d-flex gap-2">
        <form method="post" action="/admin/classes/<%= klass.id %>/duplicate" class="mb-0">
          <button class="btn btn-outline-secondary">
            <i class="bi bi-files"></i> Duplicate
          </button>
        </form>
      </div>
      <% } %>
    </div>
  </header>

  <main class="container pb-4" role="main">
    <!-- Overview & Schedule -->
    <div class="two-col">
      <section class="cardish" aria-labelledby="overview-title">
        <div class="section-title"><span class="dot"></span><span id="overview-title">Overview</span></div>
        <% if (!klass.description) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üìù</div>
            <div class="fw-semibold">No description</div>
            <div class="small">Add a brief summary of the class so students know what to expect.</div>
          </div>
        <% } else { %>
          <p class="mb-0 text-muted"><%= klass.description %></p>
        <% } %>
      </section>

      <section class="cardish" aria-labelledby="schedule-title">
        <div class="section-title"><span class="dot"></span><span id="schedule-title">Schedule</span></div>
        <% if (!((klass.schedule||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üìÖ</div>
            <div class="fw-semibold">No scheduled meetings yet</div>
            <div class="small">Add day/time slots to populate the schedule.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.schedule || []).forEach(s => { %>
              <li class="mb-1">
                <strong><%= s.day %></strong>: <%= s.time %>
                <% if (s.holiday) { %><span class="badge badge-holiday ms-2">Holiday</span><% } %>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </section>
    </div>

    <!-- Lectures & Tests -->
    <div class="two-col">
      <section class="cardish" id="lectures" aria-labelledby="lectures-title">
        <div class="section-title"><span class="dot"></span><span id="lectures-title">Lectures</span></div>
        <% if (!((klass.lectures||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üé•</div>
            <div class="fw-semibold">No lectures linked</div>
            <div class="small">Attach lecture links or files for quick access.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.lectures || []).forEach(l => { %>
              <li class="mb-1">
                <a href="<%= l.url %>" target="_blank" rel="noopener"><%= l.title %></a>
              </li>
            <% }) %>
          </ul>
        <% } %>
          <% if (typeof studentView === 'undefined' || !studentView) { %>
          <form method="POST" action="/admin/classes/<%= klass.id %>/lectures" class="mt-3 d-flex gap-2 flex-wrap">
            <input type="text" name="title" class="form-control" placeholder="Title" style="max-width:200px">
            <input type="url" name="url" class="form-control" placeholder="URL">
            <button class="btn btn-sm btn-primary" type="submit">Add</button>
          </form>
        <% } %>
      </section>
      <section class="cardish" id="simulations" aria-labelledby="sim-title">
        <div class="section-title"><span class="dot"></span><span id="sim-title">Simulations</span></div>
        <% if (!((klass.simulations||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üïπÔ∏è</div>
            <div class="fw-semibold">No simulations linked</div>
            <div class="small">Attach simulation links for practice.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.simulations || []).forEach(l => { %>
              <li class="mb-1"><a href="<%= l.url %>" target="_blank" rel="noopener"><%= l.title %></a></li>
            <% }) %>
          </ul>
        <% } %>
        <% if (typeof studentView === 'undefined' || !studentView) { %>
          <form method="POST" action="/admin/classes/<%= klass.id %>/simulations" class="mt-3 d-flex gap-2 flex-wrap">
            <input type="text" name="title" class="form-control" placeholder="Title" style="max-width:200px">
            <input type="url" name="url" class="form-control" placeholder="URL">
            <button class="btn btn-sm btn-primary" type="submit">Add</button>
          </form>
        <% } %>
      </section>

      <section class="cardish" id="tests" aria-labelledby="tests-title">
        <div class="section-title"><span class="dot"></span><span id="tests-title">Tests</span></div>
        <% if (!((klass.tests||[]).length)) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üß™</div>
            <div class="fw-semibold">No tests created</div>
            <div class="small">Create tests to assess progress and readiness.</div>
          </div>
        <% } else { %>
          <ul class="list-plain">
            <% (klass.tests || []).forEach(t => { %>
              <% if (typeof studentView !== 'undefined' && studentView) { %>
                <li class="d-flex justify-content-between align-items-center mb-1">
                  <span><%= t.title %></span>
                  <div class="d-flex gap-2">
                    <a class="btn btn-sm btn-primary" href="/student/classes/<%= klass.id %>/tests/<%= t.id %>">Take</a>
                    <a class="btn btn-sm btn-outline-primary" href="/student/classes/<%= klass.id %>/tests/<%= t.id %>/study">Study</a>
                  </div>                </li>
              <% } else { %>
                <li class="mb-1"><%= t.title %></li>
              <% } %>
            <% }) %>
          </ul>
        <% } %>
          <% if (typeof studentView === 'undefined' || !studentView) { %>
          <form method="POST" action="/admin/classes/<%= klass.id %>/tests/generate" class="mt-3">
            <input class="form-control mb-2" type="text" name="title" placeholder="Test title">
            <textarea class="form-control mb-2" name="prompt" placeholder="Topic or prompt"></textarea>
                  <input class="form-control mb-2" type="number" name="timeLimit" value="90" min="1" placeholder="Seconds per question">
            <button class="btn btn-sm btn-primary" type="submit">Generate via AI</button>
          </form>
          <form method="POST" action="/admin/classes/<%= klass.id %>/tests/upload" enctype="multipart/form-data" class="mt-3">
            <input class="form-control mb-2" type="text" name="title" placeholder="Test title">
            <input class="form-control mb-2" type="file" name="csv" accept=".csv">
                   <input class="form-control mb-2" type="number" name="timeLimit" value="90" min="1" placeholder="Seconds per question">
            <button class="btn btn-sm btn-secondary" type="submit">Upload CSV</button>
          </form>
              <form method="POST" action="/admin/classes/<%= klass.id %>/tests/media" enctype="multipart/form-data" class="mt-3">
            <input class="form-control mb-2" type="file" name="media" accept="image/*,audio/*,video/*">
            <button class="btn btn-sm btn-secondary" type="submit">Upload Test Media</button>
          </form>
        <% } %>
      </section>
    </div>
        <!-- Discussion Board -->
    <section class="cardish" id="discussion" aria-labelledby="discussion-title">
      <div class="section-title"><span class="dot"></span><span id="discussion-title">Discussion Board</span></div>
      <% if (!(discussions||[]).length) { %>
        <div class="empty">No messages yet.</div>
      <% } else { %>
        <ul class="list-plain">
          <% discussions.forEach(d => { %>
            <li class="mb-1"><strong><%= d.name %>:</strong> <%= d.message %> <span class="muted small"><%= new Date(d.createdAt).toLocaleString() %></span></li>
          <% }) %>
        </ul>
      <% } %>
      <% if (typeof studentView !== 'undefined' && studentView) { %>
        <form method="POST" action="/student/classes/<%= klass.id %>/discussion" class="mt-3 d-flex gap-2">
          <input type="text" name="message" class="form-control" placeholder="Enter message">
          <button type="submit" class="btn btn-primary btn-sm">Post</button>
        </form>
      <% } %>
    </section>


    <!-- Admin-only: Students -->
    <% if (typeof studentView === 'undefined' || !studentView) { %>
      <section class="cardish" aria-labelledby="students-title">
        <div class="section-title"><span class="dot"></span><span id="students-title">Students</span></div>

        <form method="post" action="/admin/classes/<%= klass.id %>/add-student" class="row g-2 align-items-center mb-3">
          <div class="col-12 col-md-auto">
            <label class="visually-hidden" for="studentId">Student</label>
            <select id="studentId" name="studentId" class="form-select" style="min-width:240px;">
              <% (students || []).forEach(s => { %>
                <% if (!(klass.studentIds||[]).includes(s.id)) { %>
                  <option value="<%= s.id %>"><%= s.name %> (@<%= s.username %>)</option>
                <% } %>
              <% }) %>
            </select>
          </div>
          <div class="col-12 col-md-auto">
            <button class="btn btn-outline-primary">
              <i class="bi bi-person-plus"></i> Add Student
            </button>
          </div>
        </form>

        <% const roster = (classStudents || []); %>
        <% if (!roster.length) { %>
          <div class="empty">
            <div class="fs-4 mb-1">üßë‚Äçüè´</div>
            <div class="fw-semibold">No students enrolled</div>
            <div class="small">Add students to build the class roster.</div>
          </div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
              <thead>
                <tr>
                  <th style="min-width:220px;">Student</th>
                  <th style="min-width:160px;">Username</th>
                  <th style="min-width:120px;">Profile</th>
                </tr>
              </thead>
              <tbody>
                <% roster.forEach(s => { %>
                  <tr>
                    <td><%= s.name %></td>
                    <td>@<%= s.username %></td>
                    <td>
                      <a class="btn btn-sm btn-outline-secondary" href="/admin/students/<%= s.id %>">
                        <i class="bi bi-box-arrow-up-right"></i> Open
                      </a>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>

   
    <% } %>
  </main>
</body>
</html>
