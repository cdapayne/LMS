<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Classes – University LMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="<%= branding?.favicon %>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --primary-color: dodgerblue;
      --secondary-color: orange;
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --focus: rgba(30,144,255,.35);
    }
    *{ box-sizing: border-box; }
    body{ background: var(--bg); font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color:#111827; }

    /* Page head */
    .page-head{
      background: linear-gradient(180deg, rgba(30,144,255,.10), rgba(255,165,0,.06));
      border-bottom: 1px solid var(--border);
      padding: 1rem 0; margin-bottom: 1rem;
    }
    .page-head h2{ margin:0; font-weight:800; font-size: clamp(1.1rem, 2.4vw, 1.5rem); }
    .muted{ color: var(--muted); }
    .pill{
      display:inline-block; background:#fff; border:1px solid var(--border);
      border-radius:999px; padding:.35rem .7rem; font-weight:600;
      box-shadow: 0 .3rem .8rem rgba(0,0,0,.04);
    }

    /* Toolbar */
    .tools-bar{ gap:.5rem; }
    .form-control:focus, .btn:focus{
      box-shadow: 0 0 0 .25rem var(--focus) !important;
      outline:none !important;
    }

    /* Cards/list */
    .class-card{
      border:1px solid var(--border); border-radius:12px; background:#fff; padding:1rem;
      display:flex; flex-direction:column; gap:.5rem; height:100%;
      box-shadow: 0 .5rem 1rem rgba(0,0,0,.04);
    }
    .class-title{ font-weight:800; font-size:1.05rem; }
    .class-sub{ font-size:.95rem; color: var(--muted); }
    .badge-holiday{ background:#fff3cd; color:#7a5b00; border:1px solid #ffe69c; }
    .btn-group .btn{ min-width:92px; }

    /* Grid on larger screens; list on mobile */
    #classList{ display:grid; gap:.75rem; }
    @media (min-width: 576px){ #classList{ grid-template-columns: 1fr; } }
    @media (min-width: 768px){ #classList{ grid-template-columns: 1fr 1fr; } }
    @media (min-width: 1200px){ #classList{ grid-template-columns: 1fr 1fr 1fr; } }

    /* Themed buttons */
    .btn-primary{ background: var(--primary-color) !important; border-color: var(--primary-color) !important; }
    .btn-primary:hover{ background:#1e6edb !important; border-color:#1e6edb !important; }
    .btn-outline-primary{ color: var(--primary-color) !important; border-color: var(--primary-color) !important; }
    .btn-outline-primary:hover{ background: var(--primary-color) !important; color:#fff !important; }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>
<body>
  <%- include('header', { user: user }) %>

  <!-- Page Head -->
  <div class="page-head">
    <div class="container d-flex flex-wrap justify-content-between align-items-end gap-2">
      <div>
        <h2>Welcome, <%= user.name %></h2>
        <div class="muted mt-1">Your current enrollments with quick links to lectures, simulations and tests.</div>
      </div>
      <div>
        <span class="pill">Classes Enrolled In: <%= classes.length %></span>
      </div>
    </div>
  </div>

  <div class="container pb-4">
        <% if ((announcements || []).length) { %>
      <section class="mb-4">
        <h5>Announcements</h5>
        <ul class="list-group">
          <% announcements.forEach(a => { %>
          <li class="list-group-item d-flex justify-content-between align-items-center gap-3"
    data-ann-id="<%= a.id || a._id || (a.classId ? `${a.classId}-` : '') + new Date(a.createdAt).getTime() %>">
  <span class="flex-grow-1">
    <% if (a.classId) { %>
      <strong><%= (classes.find(c => c.id === a.classId) || {}).name %>:</strong>
    <% } %>
    <%= a.message %>
  </span>

  <div class="d-flex align-items-center gap-3">
    <small class="text-muted"><%= new Date(a.createdAt).toLocaleString() %></small>

    <!-- Hide (remove) button -->
    <button type="button"
            class="btn btn-sm btn-outline-secondary hide-ann"
            title="Hide this announcement"
            aria-label="Hide this announcement">
      Hide
    </button>
    <!-- Or use a close icon:
    <button type="button" class="btn-close hide-ann" aria-label="Hide"></button>
    -->
  </div>
</li>
          <% }) %>
        </ul>
      </section>
    <% } %>
    <div class="d-flex flex-wrap tools-bar mb-3">
      <% if (classes.length) { %>
        <input id="searchInput" class="form-control" placeholder="Search by class name or schedule…" aria-label="Search classes">
        <button id="clearSearch" class="btn btn-outline-secondary">Clear</button>
      <% } %>
              <a href="/student/simplify" class="btn btn-outline-primary ms-auto">Topic Helper</a>
      <a href="/student/study" class="btn btn-outline-primary">Study Test</a>
    </div>
        <div class="row mb-4">
      <div class="col-md-6 mb-3 mb-md-0">
        <h5>Latest Grades</h5>
        <% if ((latestGrades || []).length) { %>
          <ul class="list-group">
            <% latestGrades.forEach(g => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div><strong><%= g.className %></strong> - <%= g.testTitle %></div>
                  <div class="small text-muted">Graded <%= new Date(g.gradedAt).toLocaleDateString() %></div>
                </div>
                <span class="badge bg-primary rounded-pill"><%= g.score %>%</span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-muted">No grades yet.</div>
        <% } %>
      </div>
      <div class="col-md-6">
        <h5>Homework</h5>
        <% if ((tasks || []).length) { %>
          <ul class="list-group">
            <% tasks.forEach(t => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div><strong><%= t.className %></strong> - <%= t.title %></div>
                  <div class="small text-muted">Due <%= new Date(t.dueDate).toLocaleDateString() %></div>
                </div>
                <a href="/student/classes/<%= t.classId %>/tests/<%= t.testId %>" class="btn btn-sm btn-outline-primary">Open</a>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-muted">No homework assigned.</div>
        <% } %>
      </div>
    </div>
    <% if (classes.length === 0) { %>
      <div class="class-card">
        <div class="alert alert-info m-0">You are not enrolled in any classes yet.</div>
      </div>
    <% } else { %>
     <div id="classList" role="list">
        <% function fmt(t){ if(!t) return ''; const parts=String(t).split(':'); let h=parseInt(parts[0],10), m=parts[1]||'00'; const ampm=h>=12?'PM':'AM'; h=h%12||12; return h+":"+m+" "+ampm; } %>
        <% classes.forEach(k => {
             const firstSlot = (k.schedule||[])[0];
             const schedText = (k.schedule||[]).map(s => s.day + ' ' + fmt(s.start) + ' - ' + fmt(s.end)).join(' • ');
        %>
          <article class="class-card"
                   role="listitem"
                   aria-label="<%= k.name %>"
                   data-name="<%= (k.name||'').toLowerCase() %>"
                   data-sched="<%= (schedText||'').toLowerCase() %>">
            <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
              <div>
                <div class="class-title"><%= k.name %></div>
                <div class="class-sub">
                  <% if (k.shortName) { %><span class="me-2">(<%= k.shortName %>)</span><% } %>
                  <% if (schedText) { %>
                    <span><%= schedText %></span>
                  <% } else { %>
                    <span class="text-muted">No schedule posted</span>
                  <% } %>
                </div>
                <% if (firstSlot) { %>
                  <div class="mt-1 small">
                    <span class="text-muted">Next session:</span>
                    <strong><%= firstSlot.day %></strong>
                    <span class="text-muted">at</span>
                    <strong><%= fmt(firstSlot.start) %> – <%= fmt(firstSlot.end) %></strong>
                    <% if (firstSlot.holiday) { %><span class="badge badge-holiday ms-2">Holiday</span><% } %>
                  </div>
                <% } %>
                    <% const grade = (currentGrades || {})[k.id]; %>
                <% if (grade !== undefined) { %>
                  <div class="mt-1 small">
                    <span class="text-muted">Current Grade:</span>
                    <strong><%= grade %>%</strong>
                  </div>
                <% } %>
              </div>

              <div class="btn-group" role="group" aria-label="Class quick actions">
                <a class="btn btn-outline-secondary btn-sm" href="/student/classes/<%= k.id %>#lectures">Lectures</a>
                        <a class="btn btn-outline-secondary btn-sm" href="/student/classes/<%= k.id %>#simulations">Simulations</a>
                                     <a class="btn btn-outline-secondary btn-sm" href="/student/classes/<%= k.id %>#assignments">Assignments</a>
                <a class="btn btn-outline-primary btn-sm" href="/student/classes/<%= k.id %>#tests">Tests</a>
              </div>
            </div>
          </article>
        <% }); %>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="muted small">Showing <span id="rowCount"><%= classes.length %></span> classes</div>
      </div>
    <% } %>
  </div>

  <% if (classes.length) { %>
  <script>
    (function(){
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearch');
      const list = document.getElementById('classList');
      const count = document.getElementById('rowCount');

      function norm(s){ return (s||'').toString().toLowerCase(); }

      function filter(){
        const q = norm(input.value);
        let shown = 0;
        Array.from(list.children).forEach(card => {
          const name = card.getAttribute('data-name') || '';
          const sched = card.getAttribute('data-sched') || '';
          const match = !q || name.includes(q) || sched.includes(q);
          card.style.display = match ? '' : 'none';
          if (match) shown++;
        });
        count.textContent = shown;
      }

      input?.addEventListener('input', filter);
      clearBtn?.addEventListener('click', () => { input.value=''; filter(); });
    })();
     (function(){
    const KEY = 'hiddenAnnouncements'; // localStorage key

    function loadHiddenSet(){
      try { return new Set(JSON.parse(localStorage.getItem(KEY) || '[]')); }
      catch { return new Set(); }
    }
    function saveHiddenSet(set){
      localStorage.setItem(KEY, JSON.stringify(Array.from(set)));
    }

    const hidden = loadHiddenSet();

    // Hide any items that were previously dismissed
    document.querySelectorAll('[data-ann-id]').forEach(li => {
      const id = li.getAttribute('data-ann-id');
      if (hidden.has(id)) li.remove();
    });

    // Wire up Hide buttons
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.hide-ann');
      if (!btn) return;
      const li = btn.closest('[data-ann-id]');
      if (!li) return;

      const id = li.getAttribute('data-ann-id');
      hidden.add(id);
      saveHiddenSet(hidden);
      li.remove();
    });
  })();
  </script>
  <% } %>
</body>
</html>
