<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Email Templates â€“ Admin | MD Technical School</title>
  <link rel="icon" href="<%= branding?.favicon %>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('header', { user: user }) %>
  <div class="container mt-4">
    <h2>Email Templates</h2>
    <% if (saved) { %>
      <div class="alert alert-success">Template saved.</div>
    <% } %>
    <form id="selectForm" method="get" action="/admin/email-templates" class="mb-3">
      <label class="form-label">Template</label>
      <select name="key" class="form-select" onchange="document.getElementById('selectForm').submit()">
        <% Object.keys(templates).forEach(function(k){ %>
          <option value="<%= k %>" <%= selectedKey===k?'selected':'' %>><%= k %></option>
        <% }); %>
      </select>
    </form>
    <% if (selectedKey) { %>
    <form method="post" action="/admin/email-templates/save">
      <input type="hidden" name="key" value="<%= selectedKey %>">
      <div class="mb-3">
        <label class="form-label">Subject</label>
        <input type="text" name="subject" class="form-control" value="<%= template.subject %>">
      </div>
      <div class="mb-3">
        <label class="form-label">HTML</label>
        <textarea name="html" class="form-control" rows="10"><%= template.html %></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Preview</label>
        <div id="htmlPreview" class="border rounded p-3"></div>
      </div>
      <div class="mb-3">
        <label class="form-label">AI Prompt</label>
        <textarea id="aiPrompt" class="form-control" rows="3"></textarea>
        <button type="button" id="aiBtn" class="btn btn-secondary mt-2">Generate with AI</button>
      </div>
      <button type="submit" class="btn btn-primary">Save</button>
    </form>
    <% } %>
  </div>
<script>
  const htmlBox = document.querySelector('textarea[name="html"]');
  const preview = document.getElementById('htmlPreview');
  function updatePreview(){ preview.innerHTML = htmlBox.value; }
  htmlBox?.addEventListener('input', updatePreview);
  document.addEventListener('DOMContentLoaded', updatePreview);

  document.getElementById('aiBtn')?.addEventListener('click', async () => {
    const prompt = document.getElementById('aiPrompt').value;
    if (!prompt.trim()) return;
    const res = await fetch('/admin/email-templates/ai', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await res.json();
    if (data.html) {
      htmlBox.value = data.html;
      updatePreview();
    }
  });
</script>
</body>
</html>